# Implementation Plan: Authentication

**Branch**: `001-authentication` | **Date**: 2026-02-22 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `specs/001-authentication/spec.md`

## Summary

Secure the app so only the owner can access it. All routes are protected by Auth.js v5
middleware. Google OAuth is the sole sign-in method, restricted to a single email address
(`AUTHORIZED_EMAIL`). On first sign-in, a `User` and `UserSettings` record are created
atomically via Prisma upsert. Sessions are stateless JWTs with 30-day sliding expiry.
Sign-out clears the client cookie (soft sign-out — no server-side revocation needed).

## Technical Context

**Language/Version**: TypeScript 5 / Node.js 18+
**Primary Dependencies**: Next.js 14+ (App Router), Auth.js v5 (next-auth@beta), Prisma, Vercel Postgres
**Storage**: Vercel Postgres (PostgreSQL) — User and UserSettings tables
**Testing**: Manual verification via quickstart checklist (no automated tests in this epic)
**Target Platform**: Vercel (serverless, Node.js runtime — not edge)
**Performance Goals**: Sign-in flow completes in < 10s on mobile (SC-001)
**Constraints**: JWT sessions only (no session table); `AUTHORIZED_EMAIL` server-side only; soft sign-out
**Scale/Scope**: Single user; 2 database tables; 5 source files

## Constitution Check

*Pre-Phase 0 gate — must pass before implementation.*

| Principle | Gate | Status |
|-----------|------|--------|
| I. Mobile-First UX | Sign-in page: 44px touch targets, mobile-first layout, `rounded-full` button | ✅ Addressed in contracts/auth-surface.md UI contract |
| II. Security by Default | Middleware protects all routes; `signIn` callback rejects unauthorized emails; `AUTHORIZED_EMAIL` server-side only | ✅ Core purpose of this epic |
| III. Server-First | Sign-in page is a Server Component; `auth()` called server-side; no client-side session fetching | ✅ Enforced by design |
| IV. Data Integrity | Upsert is idempotent (FR-006); User + UserSettings created atomically | ✅ Nested Prisma create |
| V. Premium Simplicity | Design tokens used; `animate-shake` (no `motion-safe:`) for error; `motion-safe:animate-fade-in` for card entrance | ✅ Specified in epic design notes |

**No violations. No complexity tracking needed.**

*Post-Phase 1 re-check*: All gates remain green. The data model introduces no new complexity. The auth surface contract is narrow and well-bounded.

## Project Structure

### Documentation (this feature)

```text
specs/001-authentication/
├── plan.md              ← this file
├── research.md          ← Auth.js v5 + Prisma patterns
├── data-model.md        ← User, UserSettings, Session (conceptual)
├── quickstart.md        ← Local setup steps
├── contracts/
│   └── auth-surface.md  ← auth(), middleware, sign-in page, env vars
└── tasks.md             ← generated by /speckit.tasks
```

### Source Code (repository root)

```text
prisma/
└── schema.prisma             # User + UserSettings models (+ future models)

src/
├── app/
│   ├── layout.tsx            # Root layout (no auth changes here)
│   ├── page.tsx              # Home — protected by middleware
│   ├── auth/
│   │   └── signin/
│   │       └── page.tsx      # Custom sign-in page (public)
│   └── api/
│       └── auth/
│           └── [...nextauth]/
│               └── route.ts  # Auth.js route handler
├── lib/
│   ├── auth.ts               # Auth.js config, exports: auth, handlers, signIn, signOut
│   └── prisma.ts             # Prisma client singleton
└── middleware.ts             # Exports auth as default; matcher excludes /auth/* /api/auth/*
```

**Structure Decision**: Next.js App Router with `src/` directory. Auth is a cross-cutting concern — `middleware.ts` is the only file that sits at the `src/` root level and affects every route. All auth logic is isolated to `src/lib/auth.ts`.

## Implementation Approach

### Phase 0 — Prisma Schema & Database

Set up the database schema first. Everything else depends on the `User` table existing.

1. Initialize Prisma (`npx prisma init`)
2. Write `prisma/schema.prisma` with `User` and `UserSettings` models
3. Run `npx prisma migrate dev --name init-auth`
4. Implement `src/lib/prisma.ts` singleton

### Phase 1 — Auth.js Configuration

5. Implement `src/lib/auth.ts`:
   - Google provider with `AUTH_GOOGLE_ID` / `AUTH_GOOGLE_SECRET`
   - `signIn` callback: reject emails not matching `AUTHORIZED_EMAIL`
   - `signIn` callback: Prisma upsert User + nested create UserSettings on first login
   - JWT session: `maxAge: 30d`, `updateAge: 24h`
   - Session callback: attach `user.id` to session
   - Pages config: `signIn: "/auth/signin"`
   - Export `{ auth, handlers, signIn, signOut }`
6. Implement `src/app/api/auth/[...nextauth]/route.ts` — re-export `handlers` as GET/POST

### Phase 2 — Route Protection

7. Implement `src/middleware.ts`:
   - Export `auth` as default
   - `authorized` callback returns `!!auth` (allow only authenticated)
   - Matcher: all paths except `_next/static`, `_next/image`, `favicon.ico`, `api/auth`

### Phase 3 — Sign-In Page

8. Implement `src/app/auth/signin/page.tsx`:
   - Server Component (reads `searchParams` for `error` param)
   - Design tokens: `bg-[--color-background]`, card `bg-[--color-card] rounded-2xl p-4`
   - Card entrance: `motion-safe:animate-fade-in`
   - "Sign in with Google" button: `bg-[--color-primary] rounded-full min-h-11 min-w-11`
   - Error display (`error=AccessDenied`): "This app is private. Access denied." with `animate-shake`
   - OAuth error display: "Sign-in is temporarily unavailable. Please try again later."
   - Sign-in action calls Auth.js `signIn("google")`

### Verification

Run quickstart checklist (see `quickstart.md`).
